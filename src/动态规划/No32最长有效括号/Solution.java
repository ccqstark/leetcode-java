package åŠ¨æ€è§„åˆ’.No32æœ€é•¿æœ‰æ•ˆæ‹¬å·;

public class Solution {
    public int longestValidParentheses(String s) {
        int n = s.length();
        // ç‰¹æ®Šé•¿åº¦ç‰¹åˆ¤ä¸€ä¸‹
        if (n == 0 || n == 1) return 0;
        char[] arr = s.toCharArray();
        // dp[i]è¡¨ç¤ºä»¥arr[i]ç»“å°¾çš„å­—ç¬¦ä¸²ä¸­ï¼Œæœ€é•¿çš„æœ‰æ•ˆæ‹¬å·é•¿åº¦
        int[] dp = new int[n];
        // å› ä¸ºä¸‹é¢åŠ¨è§„éœ€è¦ç”¨åˆ°i-2ï¼Œæ‰€ä»¥åˆå§‹åŒ–åˆ°dp[1]
        dp[1] = arr[0] == '(' && arr[1] == ')' ? 2 : 0;
        int max = dp[1]; // å…¨å±€æœ€å¤§å€¼

        for (int i = 2; i < n; i++) {
            // (( æˆ– )( ï¼Œç›´æ¥é•¿åº¦ä¸º0
            if (arr[i] == '(') dp[i] = 0;
            // ä¸‹é¢è¯´æ˜arr[i]æ˜¯ )
            else {
                // é‡åˆ°()ï¼Œå°±æ˜¯dp[i-2]åŠ ä¸Šç°åœ¨è¿™ä¸€ä¸ªæœ‰æ•ˆæ‹¬å·é•¿åº¦2
                if (arr[i - 1] == '(') dp[i] = dp[i - 2] + 2;
                    //                                    ğŸ‘‡
                    // é‡åˆ°))ï¼Œç”±äºå‰é¢æƒ…å†µåº”è¯¥æ˜¯è¿™æ ·   ?((...))
                    // æ‰‹æŒ‡æŒ‡å‘iï¼Œdp[i-1]è¡¨ç¤º(...)ä¸­çš„æœ‰æ•ˆæ‹¬å·é•¿åº¦
                    // i - dp[i-1] -1 å°±æ˜¯ä¸Šå›¾ä¸­?å·å³è¾¹çš„é‚£ä¸ªæ‹¬å·ï¼Œä¹Ÿå°±æ˜¯è¦å’Œarr[i]è¿›è¡ŒåŒ¹é…çš„é‚£ä¸€åŠæ‹¬å·
                    // ?ä»£è¡¨å†å¾€å‰é¢å¯èƒ½çš„ä¸€äº›æƒ…å†µ
                else {
                    // å‰é¢ä¸å¤Ÿè¶Šç•Œäº†æˆ–è€…ä¸èƒ½å’Œarr[i]å½¢æˆæœ‰æ•ˆæ‹¬å·ï¼Œdpç›´æ¥ä¸º0
                    if (i - dp[i - 1] - 1 < 0 || arr[i - dp[i - 1] - 1] == ')') dp[i] = 0;
                    // åˆ°ä¸‹é¢å°±è¯´æ˜arr[i - dp[i - 1] - 1]ä¸arr[i]åŒ¹é…ä¸Šäº†
                    // è¿™é‡Œæ˜¯åˆ¤æ–­?å·ä½ç½®æ˜¯å¦å­˜åœ¨ï¼Œ?çš„ä¸‹æ ‡å°±æ˜¯i - dp[i - 1] - 2
                    // å­˜åœ¨é‚£ä¹ˆç»“æœå°±æ˜¯ä¸‰ä¸ªéƒ¨åˆ†ï¼Œ? + 2 + dp[i-1]ï¼Œè¿™ä¸ª2å°±æ˜¯arr[i - dp[i - 1] - 1]ä¸arr[i]
                    // å¦‚æœå°äº0è¶Šç•Œäº†ï¼Œé‚£ä¹ˆç»“æœåªæœ‰ä¸¤éƒ¨åˆ†ä¹Ÿå°±æ˜¯ä¸å­˜åœ¨?é‚£éƒ¨åˆ†ï¼Œå°±æ˜¯2 + dp[i - 1]
                    else dp[i] = i - dp[i - 1] - 2 >= 0 ? dp[i - dp[i - 1] - 2] + 2 + dp[i - 1] : 2 + dp[i - 1];
                }
            }
            max = Math.max(max, dp[i]);
        }
        return max;
    }
}
